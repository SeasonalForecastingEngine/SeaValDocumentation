<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Data import and processing |  The SeaVal package for validating seasonal weather forecasts</title>
  <meta name="description" content="<br />
The <code>SeaVal</code> package for validating seasonal weather forecasts</p>" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Data import and processing |  The SeaVal package for validating seasonal weather forecasts" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Data import and processing |  The SeaVal package for validating seasonal weather forecasts" />
  
  
  

<meta name="author" content="Claudio Heinrich and Michael Scheuerer, with input from" />
<meta name="author" content="Masilin Gudoshava, Eunice Koech, Anthony Mwanthi, Zewdu Segele, Hussen Seid and Thordis Thorarinsdottir" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-import-and-processing.html"/>
<link rel="next" href="validation.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#installation"><i class="fa fa-check"></i><b>1.1</b> Installation</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#examples-of-data.table-syntax"><i class="fa fa-check"></i><b>1.2</b> examples of <code>data.table</code> syntax</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>2</b> Plotting</a>
<ul>
<li class="chapter" data-level="2.1" data-path="plotting.html"><a href="plotting.html#plotting-values-for-selected-countries"><i class="fa fa-check"></i><b>2.1</b> Plotting values for selected countries</a></li>
<li class="chapter" data-level="2.2" data-path="plotting.html"><a href="plotting.html#customized-plots"><i class="fa fa-check"></i><b>2.2</b> Customized plots</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-import-and-processing.html"><a href="data-import-and-processing.html"><i class="fa fa-check"></i><b>3</b> Data import and processing</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-import-and-processing.html"><a href="data-import-and-processing.html#netcdf_to_dt"><i class="fa fa-check"></i><b>3.1</b> The function <code>netcdf_to_dt</code></a></li>
<li class="chapter" data-level="3.2" data-path="data-import-and-processing.html"><a href="data-import-and-processing.html#chirps"><i class="fa fa-check"></i><b>3.2</b> Downloading and processing CHIRPS data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html"><i class="fa fa-check"></i><b>4</b> Data import and processing</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html#data-examples"><i class="fa fa-check"></i><b>4.1</b> Reshaping data</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html#cv-data"><i class="fa fa-check"></i><b>4.1.1</b> Example: cross-validation data</a></li>
<li class="chapter" data-level="4.1.2" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html#us-obs"><i class="fa fa-check"></i><b>4.1.2</b> Example: Tercile forecasts and upscaling</a></li>
<li class="chapter" data-level="4.1.3" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html#ex-corrupted-netcdf"><i class="fa fa-check"></i><b>4.1.3</b> Example: ‘corrupted’ netcdf</a></li>
<li class="chapter" data-level="4.1.4" data-path="data-import-and-processing-1.html"><a href="data-import-and-processing-1.html#data-ex-prexc"><i class="fa fa-check"></i><b>4.1.4</b> Example: preparing data for evaluating exceedence probabilities</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="validation.html"><a href="validation.html"><i class="fa fa-check"></i><b>5</b> Validation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="validation.html"><a href="validation.html#cv-eval"><i class="fa fa-check"></i><b>5.1</b> Evaluating cross-validation predictions</a></li>
<li class="chapter" data-level="5.2" data-path="validation.html"><a href="validation.html#evaluating-tercile-forecasts"><i class="fa fa-check"></i><b>5.2</b> Evaluating Tercile Forecasts</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="validation.html"><a href="validation.html#eval-terciles"><i class="fa fa-check"></i><b>5.2.1</b> Proper scoring rules for full tercile forecasts</a></li>
<li class="chapter" data-level="5.2.2" data-path="validation.html"><a href="validation.html#eval-terciles2"><i class="fa fa-check"></i><b>5.2.2</b> Evaluation when only the highest probability category is avaliable</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="validation.html"><a href="validation.html#eval-ex-pr"><i class="fa fa-check"></i><b>5.3</b> Exceedence probabilities</a></li>
<li class="chapter" data-level="5.4" data-path="validation.html"><a href="validation.html#temperature"><i class="fa fa-check"></i><b>5.4</b> Temperature</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="validation-1.html"><a href="validation-1.html"><i class="fa fa-check"></i><b>6</b> Validation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="validation-1.html"><a href="validation-1.html#upscaling"><i class="fa fa-check"></i><b>6.1</b> Matching predictions and observations</a></li>
<li class="chapter" data-level="6.2" data-path="validation-1.html"><a href="validation-1.html#evaluating-weekly-predictions-of-precipitation"><i class="fa fa-check"></i><b>6.2</b> Evaluating weekly predictions of precipitation</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="logo_CONFER.png" style="width:2in" /><br />
The <code>SeaVal</code> package for validating seasonal weather forecasts</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-import-and-processing-1" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Data import and processing</h1>
<div id="data-examples" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Reshaping data</h2>
<p>For forecast validation, the ideal data format is to have all your fore- and hindcasts in the same data table, alongside the corresponding observations. So one column of forecasts, one column of observations and several columns of dimension variables (e.g. year, month, lon,lat). However, this is rarely how your netcdf-data looks like: you’ll often have different netcdfs for observations and fore-/hindcasts. They might, moreover have different units, different missing values, different variable names etc.</p>
<p>So to get your data into the preferred shape, you either need to manipulate the netcdf files beforehand, to get exactly the data table you want from <code>netcdf_to_dt</code>, or you can extract several data tables and do the required manipulations in <code>R</code>, using <code>SeaVal</code> and <code>data.table</code>. In this section we show a few examples how to do this.</p>
<div id="cv-data" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Example: cross-validation data</h3>
<p>We first consider a crossvalidation dataset, containing predictions for the February-April rainfall.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="data-import-and-processing-1.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the two CV-files:</span></span>
<span id="cb84-2"><a href="data-import-and-processing-1.html#cb84-2" aria-hidden="true" tabindex="-1"></a>fn_pred <span class="ot">=</span> <span class="st">&quot;CrossValidatedPredictedRain_Feb-Apr_Feb2021.nc&quot;</span></span>
<span id="cb84-3"><a href="data-import-and-processing-1.html#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="data-import-and-processing-1.html#cb84-4" aria-hidden="true" tabindex="-1"></a>dt_pred <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn_pred)) <span class="co"># here data_dir is the local path to the data (not shown)</span></span></code></pre></div>
<pre><code>## File /nr/project/stat/CONFER/Data/SeaVal/example_data/202102/CrossValidatedPredictedRain_Feb-Apr_Feb2021.nc (NC_FORMAT_CLASSIC):
## 
##      1 variables (excluding dimension variables):
##         float prec[lon,lat,time]   
##             lead: 0
##             average_op_ncl: dim_avg_n over dimension(s): model
##             type: 1
##             _FillValue: -9999
## 
##      3 dimensions:
##         time  Size:35   *** is unlimited *** 
##             units: months since 1981-01-01 
##             calendar: standard
##             _FillValue: 9.96920996838687e+36
##         lat  Size:77 
##             units: degrees_north
##         lon  Size:66 
##             units: degrees_east
## 
##     5 global attributes:
##         MonInit_month: 2
##         valid_time: Feb-Apr
##         creation_date: Mon Feb 15 06:59:57 EAT 2021
##         Conventions: None
##         title:  Cross Validated Predicted Rainfall Total (mm)</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="data-import-and-processing-1.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let&#39;s look at the data:</span></span>
<span id="cb86-2"><a href="data-import-and-processing-1.html#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt_pred)</span></code></pre></div>
<pre><code>##          lon   lat time prec
##      1: 20.5 -13.5   13   NA
##      2: 21.0 -13.5   13   NA
##      3: 21.5 -13.5   13   NA
##      4: 22.0 -13.5   13   NA
##      5: 22.5 -13.5   13   NA
##     ---                     
## 177866: 51.0  24.5  421   NA
## 177867: 51.5  24.5  421   NA
## 177868: 52.0  24.5  421   NA
## 177869: 52.5  24.5  421   NA
## 177870: 53.0  24.5  421   NA</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="data-import-and-processing-1.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># it&#39;s also always good to have a look at plots:</span></span>
<span id="cb88-2"><a href="data-import-and-processing-1.html#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="data-import-and-processing-1.html#cb88-3" aria-hidden="true" tabindex="-1"></a>dt_plot <span class="ot">=</span> dt_pred[time <span class="sc">==</span> <span class="dv">13</span>] <span class="co"># subset to only one time-slize, so that we can plot a map</span></span>
<span id="cb88-4"><a href="data-import-and-processing-1.html#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot_dt</span>(dt_plot,<span class="st">&#39;prec&#39;</span>)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-1-1.png" width="480" /></p>
<p>Next we need observations to compare the predictions to. For this first example, we have a prepared netcdf with the observations available:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="data-import-and-processing-1.html#cb89-1" aria-hidden="true" tabindex="-1"></a>fn_obs <span class="ot">=</span> <span class="st">&quot;ObservedRain_Feb-Apr_Feb2021.nc&quot;</span></span>
<span id="cb89-2"><a href="data-import-and-processing-1.html#cb89-2" aria-hidden="true" tabindex="-1"></a>dt_obs <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn_obs))</span></code></pre></div>
<pre><code>## File /nr/project/stat/CONFER/Data/SeaVal/example_data/202102/ObservedRain_Feb-Apr_Feb2021.nc (NC_FORMAT_CLASSIC):
## 
##      1 variables (excluding dimension variables):
##         float prec[lon,lat,time]   
##             lead: 0
##             average_op_ncl: dim_avg_n over dimension(s): model
##             type: 0
##             _FillValue: -9999
## 
##      3 dimensions:
##         time  Size:35   *** is unlimited *** 
##             units: months since 1981-01-01 
##             calendar: standard
##             _FillValue: 9.96920996838687e+36
##         lat  Size:77 
##             units: degrees_north
##         lon  Size:66 
##             units: degrees_east
## 
##     5 global attributes:
##         MonInit_month: 2
##         valid_time: Feb-Apr
##         creation_date: Mon Feb 15 06:59:57 EAT 2021
##         Conventions: None
##         title:  Observed Rainfall Total (mm)</code></pre>
<p>Now we have two data tables, one with predictions and one with observations. We want to merge them together. There are two main functions for merging data tables: <code>rbindlist</code> and <code>merge</code>. The function <code>rbindlist</code> takes several data tables, all with the same columns, and just appends them. This is appropriate when your data tables contain <em>the same type of information, but for different coordinates</em>. For example, if you have a data table with observed precipitation for 1990-2020 and a second data table with observed precipitation for 2021-2022. In our example we have two data tables but they contain <em>different types of information</em> (the first contains predictions, the second observations). However, they contain them at the same coordinates (meaning at the same locations specified by <code>lon</code>/<code>lat</code>, and for the same months specified by <code>time</code>). Such data tables are joined by the function <code>merge</code>. Before we join predictions and observations, we should rename their columns, though: Both of them currently have a column called <code>prec</code>, which contains the observations in <code>dt_obs</code> and the predictions in <code>dt_pred</code>.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="data-import-and-processing-1.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(dt_pred,<span class="st">&#39;prec&#39;</span>,<span class="st">&#39;prediction&#39;</span>)</span>
<span id="cb91-2"><a href="data-import-and-processing-1.html#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(dt_obs,<span class="st">&#39;prec&#39;</span>,<span class="st">&#39;observation&#39;</span>)</span>
<span id="cb91-3"><a href="data-import-and-processing-1.html#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="data-import-and-processing-1.html#cb91-4" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">merge</span>(dt_pred,dt_obs,</span>
<span id="cb91-5"><a href="data-import-and-processing-1.html#cb91-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>,<span class="st">&#39;time&#39;</span>))</span>
<span id="cb91-6"><a href="data-import-and-processing-1.html#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##          lon   lat time prediction observation
##      1: 20.5 -13.5   13         NA          NA
##      2: 20.5 -13.5   25         NA          NA
##      3: 20.5 -13.5   37         NA          NA
##      4: 20.5 -13.5   49         NA          NA
##      5: 20.5 -13.5   61         NA          NA
##     ---                                       
## 177866: 53.0  24.5  373         NA          NA
## 177867: 53.0  24.5  385         NA          NA
## 177868: 53.0  24.5  397         NA          NA
## 177869: 53.0  24.5  409         NA          NA
## 177870: 53.0  24.5  421         NA          NA</code></pre>
<p>The <code>by</code>-argument of the <code>merge</code> function identifies the columns that are present in both data tables. These are typically the columns specifying coordinates.
We now have prediction and observation side by side as we wanted. However, we see that also coordinates with missing values are dragged along (where both the prediction and the observation is <code>NA</code>). Let’s remove them:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="data-import-and-processing-1.html#cb93-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> dt[<span class="sc">!</span><span class="fu">is.na</span>(prediction)]</span></code></pre></div>
<p>Also, the <code>time</code> column is not really easy to read. Looking at the information printed out by <code>netcdf_to_dt</code> above tells us that the unit of time in the netcdf is months since 1981-01-01. <code>SeaVal</code> has a function called <code>MSD_to_YM</code> that converges time from this ‘months-since-date’ (MSD) format to years and months (YM), which is typically much more useful:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="data-import-and-processing-1.html#cb94-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">MSD_to_YM</span>(dt,</span>
<span id="cb94-2"><a href="data-import-and-processing-1.html#cb94-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">timecol =</span> <span class="st">&#39;time&#39;</span>, <span class="co"># what is the column called that contains the time-since-date coordinates?</span></span>
<span id="cb94-3"><a href="data-import-and-processing-1.html#cb94-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">origin =</span> <span class="st">&#39;1981-01-01&#39;</span>) <span class="co"># (the origin was documented in the netcdf, see above.)</span></span>
<span id="cb94-4"><a href="data-import-and-processing-1.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt) </span></code></pre></div>
<pre><code>##         lon   lat prediction observation year month
##     1: 20.5 -11.5  316.19452   369.36932 1982     2
##     2: 20.5 -11.5  316.20178   252.47144 1983     2
##     3: 20.5 -11.5  317.43375   267.44031 1984     2
##     4: 20.5 -11.5  313.30789   332.10236 1985     2
##     5: 20.5 -11.5  318.12195   343.65460 1986     2
##    ---                                             
## 79745: 51.5  22.5   25.44651    19.71902 2012     2
## 79746: 51.5  22.5   25.59836    27.55773 2013     2
## 79747: 51.5  22.5   26.03941    25.14965 2014     2
## 79748: 51.5  22.5   26.03053    22.23634 2015     2
## 79749: 51.5  22.5   26.00327    34.84376 2016     2</code></pre>
<p>Now the data table looks much better and contains prediction and observation side by side. The column ordering is a bit weird with predictions and observations in the middle, but this usually should not matter. In section <a href="validation.html#cv-eval">5.1</a> we continue this cross-validation example and show how to evaluate the predictions.</p>
</div>
<div id="us-obs" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Example: Tercile forecasts and upscaling</h3>
<p>In the first example we were lucky that our observations and predictions were of the same format, which is not always the case. We will now look at a more complex example where we prepare a typical tercile forecast for precipitation. We consider again the 2021 MAM season as example. Let’s get started with collecting the prediction and corresponding observations:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="data-import-and-processing-1.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions:</span></span>
<span id="cb96-2"><a href="data-import-and-processing-1.html#cb96-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,<span class="st">&#39;PredictedProbabilityRain_Mar-May_Feb2021_new.nc&#39;</span>),</span>
<span id="cb96-3"><a href="data-import-and-processing-1.html#cb96-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose =</span> <span class="dv">0</span>) <span class="co"># suppresses that the function prints all the netcdf-information</span></span>
<span id="cb96-4"><a href="data-import-and-processing-1.html#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##        lon   lat   normal    above    below
##    1: 20.5 -13.5       NA       NA       NA
##    2: 20.5 -13.0       NA       NA       NA
##    3: 20.5 -12.5       NA       NA       NA
##    4: 20.5 -12.0       NA       NA       NA
##    5: 20.5 -11.5 34.11535 33.56262 32.32204
##   ---                                      
## 5078: 53.0  22.5       NA       NA       NA
## 5079: 53.0  23.0       NA       NA       NA
## 5080: 53.0  23.5       NA       NA       NA
## 5081: 53.0  24.0       NA       NA       NA
## 5082: 53.0  24.5       NA       NA       NA</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="data-import-and-processing-1.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observation:</span></span>
<span id="cb98-2"><a href="data-import-and-processing-1.html#cb98-2" aria-hidden="true" tabindex="-1"></a>dt_obs <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,<span class="st">&#39;ObservedChirpsRainTotal_MAM2021.nc&#39;</span>),</span>
<span id="cb98-3"><a href="data-import-and-processing-1.html#cb98-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">vars =</span> <span class="st">&#39;precip&#39;</span>, <span class="co"># The netcdf file contains multiple variables, </span></span>
<span id="cb98-4"><a href="data-import-and-processing-1.html#cb98-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="co"># we only want precip.</span></span>
<span id="cb98-5"><a href="data-import-and-processing-1.html#cb98-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">verbose =</span> <span class="dv">1</span>) <span class="co"># This option only prints the units, which are usually the most important part:</span></span></code></pre></div>
<pre><code>## Units:
## precip: mm/day
## longitude: degrees_east
## latitude: degrees_north
## time: days since 1980-1-1 0:0:0
## bnds:</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="data-import-and-processing-1.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt_obs)</span></code></pre></div>
<pre><code>##         longitude latitude    time    precip
##      1:    21.825  -11.675 15080.5 249.09737
##      2:    21.875  -11.675 15080.5 255.98584
##      3:    21.925  -11.675 15080.5 268.24506
##      4:    21.975  -11.675 15080.5 285.27295
##      5:    22.025  -11.675 15080.5 259.53290
##     ---                                     
## 401964:    51.175   22.225 15080.5  20.28087
## 401965:    51.225   22.225 15080.5  20.08590
## 401966:    51.275   22.225 15080.5  21.04944
## 401967:    51.325   22.225 15080.5  21.87625
## 401968:    51.375   22.225 15080.5  20.30952</code></pre>
<p>As we can see, the observation data table looks quite different now. For example, the lon/lat columns are called <code>longitude</code> and <code>latitude</code>. If we want to visualize the data with the <code>ggplot_dt</code> function, we need to rename them:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="data-import-and-processing-1.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(dt_obs,<span class="fu">c</span>(<span class="st">&#39;longitude&#39;</span>,<span class="st">&#39;latitude&#39;</span>),<span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>))</span></code></pre></div>
<p>Let’s now look at maps of the prediction and observation side by side</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="data-import-and-processing-1.html#cb103-1" aria-hidden="true" tabindex="-1"></a>pp1 <span class="ot">=</span> <span class="fu">ggplot_dt</span>(dt_obs,<span class="st">&#39;precip&#39;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&#39;Observed MAM prec. 2021&#39;</span>)</span>
<span id="cb103-2"><a href="data-import-and-processing-1.html#cb103-2" aria-hidden="true" tabindex="-1"></a>pp2 <span class="ot">=</span> <span class="fu">ggplot_dt</span>(dt,<span class="st">&#39;above&#39;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&#39;Predicted probability of wet season&#39;</span>)</span>
<span id="cb103-3"><a href="data-import-and-processing-1.html#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="data-import-and-processing-1.html#cb103-4" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(pp1,pp2)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-9-1.png" width="480" /></p>
<p>We have two problems: First, observations and predictions are on a different spatial scale making it impossible to compare them directly. Second, the observation is only given as mm/month, and the prediction are probabilities for climatology-terciles. Therefore, we need to establish a local climatology first which requires collecting past rainfall observations. Only thereafter we can derive in which climatology-tercile the 2021 observation falls.</p>
<p>Lets first get observations and predictions onto the same scale. For validation, it is usually more appropriate to upscale everything to the coarser scale.
To this end we use the upscaling function <code>upscale_regular_lon_lat</code></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="data-import-and-processing-1.html#cb104-1" aria-hidden="true" tabindex="-1"></a>dt_obs <span class="ot">=</span> <span class="fu">upscale_regular_lon_lat</span>(dt_obs,</span>
<span id="cb104-2"><a href="data-import-and-processing-1.html#cb104-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">coarse_grid =</span> dt,  <span class="co"># to which grid do you want to upscale?</span></span>
<span id="cb104-3"><a href="data-import-and-processing-1.html#cb104-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">uscols =</span> <span class="st">&#39;precip&#39;</span>) <span class="co"># which column contains the data for upscaling?</span></span>
<span id="cb104-4"><a href="data-import-and-processing-1.html#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="data-import-and-processing-1.html#cb104-5" aria-hidden="true" tabindex="-1"></a>pp3 <span class="ot">=</span> <span class="fu">ggplot_dt</span>(dt_obs,<span class="st">&#39;precip&#39;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&#39;Upscaled MAM prec. 2021&#39;</span>)</span>
<span id="cb104-6"><a href="data-import-and-processing-1.html#cb104-6" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(pp3,pp2)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-10-1.png" width="480" /></p>
<p>Now, let us address the second problem, namely assessing where the precipitation was above or below normal. The observation we loaded contains the CHIRPS MAM average for 2021. As we showed in Section <a href="data-import-and-processing.html#chirps">3.2</a>, the <code>SeaVal</code> package provides convenient functions for locally storing CHIRPS data and loading it. So we can load a 30-year reference period like this:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="data-import-and-processing-1.html#cb105-1" aria-hidden="true" tabindex="-1"></a>dt_past_obs <span class="ot">=</span> <span class="fu">load_chirps</span>(<span class="at">years =</span> <span class="dv">1990</span><span class="sc">:</span><span class="dv">2020</span>, <span class="at">months =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb105-2"><a href="data-import-and-processing-1.html#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt_past_obs)</span></code></pre></div>
<pre><code>##          lon   lat       prec year month
##      1: 21.5 -12.0 4.77311503 1990     3
##      2: 22.0 -12.0 4.78173981 1990     3
##      3: 22.5 -12.0 4.84994405 1990     3
##      4: 23.0 -12.0 5.50729116 1990     3
##      5: 23.5 -12.0 6.09404551 1990     3
##     ---                                 
## 397106: 49.5  22.5 0.07670408 2020     5
## 397107: 50.0  22.5 0.07071957 2020     5
## 397108: 50.5  22.5 0.05828492 2020     5
## 397109: 51.0  22.5 0.05185558 2020     5
## 397110: 51.5  22.5 0.04811331 2020     5</code></pre>
<p>As we can see, the past observations are monthly, but we want the MAM season total. Moreover, the local CHIRPS data is stored in mm/day. So let us convert the units and sum the precipitation over the season:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="data-import-and-processing-1.html#cb107-1" aria-hidden="true" tabindex="-1"></a>dt_past_obs[,prec <span class="sc">:</span><span class="er">=</span> <span class="dv">30</span><span class="sc">*</span>prec] <span class="co"># conversion to mm</span></span>
<span id="cb107-2"><a href="data-import-and-processing-1.html#cb107-2" aria-hidden="true" tabindex="-1"></a>dt_past_obs <span class="ot">=</span> dt_past_obs[,.(<span class="at">precip =</span> <span class="fu">sum</span>(prec)), by <span class="ot">=</span> .(lon,lat,year)]</span></code></pre></div>
<p>Now <code>dt_past_obs</code> and <code>dt_obs</code> look very similar and we can join them together:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="data-import-and-processing-1.html#cb108-1" aria-hidden="true" tabindex="-1"></a>dt_obs[,year <span class="sc">:</span><span class="er">=</span> <span class="dv">2021</span>]</span>
<span id="cb108-2"><a href="data-import-and-processing-1.html#cb108-2" aria-hidden="true" tabindex="-1"></a>dt_obs <span class="ot">=</span> <span class="fu">rbindlist</span>(<span class="fu">list</span>(dt_past_obs,dt_obs), </span>
<span id="cb108-3"><a href="data-import-and-processing-1.html#cb108-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">use.names =</span> <span class="cn">TRUE</span>) </span></code></pre></div>
<p>Now we can derive into which local climatology-tercile the precipitation of 2021 falls, by comparing with past observations. To this end we use the utility-function <code>add_tercile_cat</code>. The function establishes a climatology, and calculates into which tercile category each value falls:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="data-import-and-processing-1.html#cb109-1" aria-hidden="true" tabindex="-1"></a>dt_obs <span class="ot">=</span> <span class="fu">add_tercile_cat</span>(dt_obs, </span>
<span id="cb109-2"><a href="data-import-and-processing-1.html#cb109-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>), <span class="co"># calculate the climatology and category separately for each location</span></span>
<span id="cb109-3"><a href="data-import-and-processing-1.html#cb109-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">datacol =</span> <span class="st">&#39;precip&#39;</span>)</span>
<span id="cb109-4"><a href="data-import-and-processing-1.html#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt_obs)</span></code></pre></div>
<pre><code>##          lon   lat year     precip tercile_cat
##      1: 21.5 -12.0 1990 297.175501           1
##      2: 22.0 -12.0 1990 291.388758           0
##      3: 22.5 -12.0 1990 295.368593           0
##      4: 23.0 -12.0 1990 320.389480           1
##      5: 23.5 -12.0 1990 329.227399           1
##     ---                                       
## 135638: 51.5  20.5 2021  25.209672           1
## 135639: 51.5  21.0 2021  21.710808           0
## 135640: 51.5  21.5 2021  23.181606           0
## 135641: 51.5  22.0 2021  23.292844          -1
## 135642: 51.5  10.5 2021   1.161395          -1</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="data-import-and-processing-1.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot_dt</span>(dt_obs[year <span class="sc">==</span> <span class="dv">2021</span>],<span class="st">&#39;tercile_cat&#39;</span>,<span class="at">low =</span> <span class="st">&#39;red&#39;</span>,<span class="at">high =</span> <span class="st">&#39;blue&#39;</span>)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-14-1.png" width="480" /></p>
<p>As we can see, the observation now contains a column <code>tercile_cat</code> that tells us whether the rainfall at this location in a given year was below normal (-1), normal (0) or above normal (1). For later use, we also add the local climatology:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="data-import-and-processing-1.html#cb112-1" aria-hidden="true" tabindex="-1"></a>dt_obs[,clim <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(precip),by <span class="ot">=</span> .(lon,lat)]</span></code></pre></div>
<p>Finally, we can merge observations and predictions. We only need the observation for 2021 (now that we have derived the tercile category).</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="data-import-and-processing-1.html#cb113-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">merge</span>(dt,dt_obs[year <span class="sc">==</span> <span class="dv">2021</span>],<span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>))</span>
<span id="cb113-2"><a href="data-import-and-processing-1.html#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="co"># transform percentage prediction to probabilities between zero and one:</span></span>
<span id="cb113-3"><a href="data-import-and-processing-1.html#cb113-3" aria-hidden="true" tabindex="-1"></a>dt[,normal <span class="sc">:</span><span class="er">=</span> normal<span class="sc">/</span><span class="dv">100</span>]</span>
<span id="cb113-4"><a href="data-import-and-processing-1.html#cb113-4" aria-hidden="true" tabindex="-1"></a>dt[,above <span class="sc">:</span><span class="er">=</span> above<span class="sc">/</span><span class="dv">100</span>]</span>
<span id="cb113-5"><a href="data-import-and-processing-1.html#cb113-5" aria-hidden="true" tabindex="-1"></a>dt[,below <span class="sc">:</span><span class="er">=</span> below<span class="sc">/</span><span class="dv">100</span>]</span>
<span id="cb113-6"><a href="data-import-and-processing-1.html#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="data-import-and-processing-1.html#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##        lon   lat    normal     above     below year    precip tercile_cat
##    1: 22.0 -11.5 0.2794044 0.3959641 0.3246315 2021 271.66260          -1
##    2: 22.0 -11.0 0.3176142 0.3509704 0.3314154 2021 279.14212          -1
##    3: 22.0 -10.5 0.2897301 0.3781255 0.3321443 2021 300.32638          -1
##    4: 22.0 -10.0 0.3133837 0.3520903 0.3345260 2021 332.45747           0
##    5: 22.0  -9.5 0.3076811 0.3480890 0.3442299 2021 407.19511           1
##   ---                                                                    
## 3268: 51.5  20.0        NA        NA        NA 2021  26.43543           1
## 3269: 51.5  20.5        NA        NA        NA 2021  25.20967           1
## 3270: 51.5  21.0        NA        NA        NA 2021  21.71081           0
## 3271: 51.5  21.5        NA        NA        NA 2021  23.18161           0
## 3272: 51.5  22.0        NA        NA        NA 2021  23.29284          -1
##            clim
##    1: 311.90872
##    2: 331.75210
##    3: 333.75472
##    4: 335.87600
##    5: 350.41710
##   ---          
## 3268:  25.26015
## 3269:  24.40523
## 3270:  22.87279
## 3271:  24.11377
## 3272:  27.69789</code></pre>
<p>We continue to work with this dataset in Section <a href="validation.html#eval-terciles">5.2.1</a>, where we evaluate this example prediction.</p>
</div>
<div id="ex-corrupted-netcdf" class="section level3" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> Example: ‘corrupted’ netcdf</h3>
<p>Data handling can be messy and things can go wrong at any stage. Here, we have a look at a netcdf file where something has gone wrong:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="data-import-and-processing-1.html#cb115-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">=</span> <span class="st">&quot;PredictedProbabilityRain_Feb-Apr_Feb2021.nc&quot;</span></span>
<span id="cb115-2"><a href="data-import-and-processing-1.html#cb115-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn))</span></code></pre></div>
<pre><code>## File /nr/project/stat/CONFER/Data/SeaVal/example_data/202102/PredictedProbabilityRain_Feb-Apr_Feb2021.nc (NC_FORMAT_CLASSIC):
## 
##      3 variables (excluding dimension variables):
##         float below[lon,lat]   
##             lead: 0
##             average_op_ncl: dim_avg_n over dimension(s): model
##             type: 0
##             _FillValue: -1
##         float normal[ncl4,ncl3]   
##             _FillValue: -1
##         float above[lon,lat]   
##             lead: 0
##             average_op_ncl: dim_avg_n over dimension(s): model
##             type: 2
##             _FillValue: -1
## 
##      5 dimensions:
##         time  Size:0   *** is unlimited *** (no dimvar)
##         lat  Size:77 
##             units: degrees_north
##         lon  Size:66 
##             units: degrees_east
##         ncl3  Size:77 (no dimvar)
##         ncl4  Size:66 (no dimvar)
## 
##     6 global attributes:
##         units: mm
##         MonInit_month: 2
##         valid_time: Mar-May
##         creation_date: Mon Feb 15 06:59:57 EAT 2021
##         Conventions: None
##         title: Predicted Tercile probability</code></pre>
<pre><code>## Error in netcdf_to_dt(paste0(data_dir, fn)): Your file has variables with disjoint dimensions, which should not be stored in a single data table. Either set trymerge to FALSE or select variables with overlapping dimensions in vars.</code></pre>
<p>The <code>netcdf_to_dt</code> function prints out the netcdf information, and then crashes with the error message above, saying that we have disjoint dimension variables for some variables. Indeed, looking at the printed out netcdf-description, we have three variables (below,normal,above), and while ‘below’ and ‘above’ are indexed by ‘lon’ and ‘lat’, ‘normal’ is indexed by ‘ncl3’ and ‘ncl4’. As the error message suggests, we can set <code>trymerge</code> to FALSE, making <code>netcdf_to_dt</code> return a list of data tables, rather than a single data table.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="data-import-and-processing-1.html#cb118-1" aria-hidden="true" tabindex="-1"></a>dt_list <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn),<span class="at">trymerge =</span> <span class="cn">FALSE</span>,<span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb118-2"><a href="data-import-and-processing-1.html#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt_list)</span></code></pre></div>
<pre><code>## [[1]]
##        lon   lat below
##    1: 20.5 -13.5    NA
##    2: 21.0 -13.5    NA
##    3: 21.5 -13.5    NA
##    4: 22.0 -13.5    NA
##    5: 22.5 -13.5    NA
##   ---                 
## 5078: 51.0  24.5    NA
## 5079: 51.5  24.5    NA
## 5080: 52.0  24.5    NA
## 5081: 52.5  24.5    NA
## 5082: 53.0  24.5    NA
## 
## [[2]]
##       ncl4 ncl3 normal
##    1:    1    1     NA
##    2:    2    1     NA
##    3:    3    1     NA
##    4:    4    1     NA
##    5:    5    1     NA
##   ---                 
## 5078:   62   77     NA
## 5079:   63   77     NA
## 5080:   64   77     NA
## 5081:   65   77     NA
## 5082:   66   77     NA
## 
## [[3]]
##        lon   lat above
##    1: 20.5 -13.5    NA
##    2: 21.0 -13.5    NA
##    3: 21.5 -13.5    NA
##    4: 22.0 -13.5    NA
##    5: 22.5 -13.5    NA
##   ---                 
## 5078: 51.0  24.5    NA
## 5079: 51.5  24.5    NA
## 5080: 52.0  24.5    NA
## 5081: 52.5  24.5    NA
## 5082: 53.0  24.5    NA</code></pre>
<p>We see that ‘ncl3’ and ‘ncl4’ have different values than ‘lon’ and ‘lat’, apparently they are meaningless indexing integers. However, the three data.tables are of the same size, and we can hope that the ‘below’ data table is arranged in the same row-ordering than the others. If this is the case, we can simply extract the ‘normal’ column from it (as vector) and attach it to one of the others. Let’s try:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="data-import-and-processing-1.html#cb120-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> dt_list[[<span class="dv">1</span>]]</span>
<span id="cb120-2"><a href="data-import-and-processing-1.html#cb120-2" aria-hidden="true" tabindex="-1"></a>normal_probs_as_vector <span class="ot">=</span> dt_list[[<span class="dv">2</span>]][,normal]</span>
<span id="cb120-3"><a href="data-import-and-processing-1.html#cb120-3" aria-hidden="true" tabindex="-1"></a>dt[,normal <span class="sc">:</span><span class="er">=</span> normal_probs_as_vector]</span>
<span id="cb120-4"><a href="data-import-and-processing-1.html#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="data-import-and-processing-1.html#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot_dt</span>(dt,<span class="st">&#39;normal&#39;</span>)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-20-1.png" width="480" /></p>
<p>Plotting is usually a great way to see whether data got arranged correctly: Here, we can be fairly certain it did, simply because the missing values in the ‘normal’ vector are at the locations where they should be (over water and dry regions). If the ordering would have been differently, these would likely be all over the place. However, let’s run another test to be certain:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="data-import-and-processing-1.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># attach the &#39;above&#39;-data table:</span></span>
<span id="cb121-2"><a href="data-import-and-processing-1.html#cb121-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">merge</span>(dt,dt_list[[<span class="dv">3</span>]],<span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>))</span>
<span id="cb121-3"><a href="data-import-and-processing-1.html#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##        lon   lat    below   normal    above
##    1: 20.5 -13.5       NA       NA       NA
##    2: 20.5 -13.0       NA       NA       NA
##    3: 20.5 -12.5       NA       NA       NA
##    4: 20.5 -12.0       NA       NA       NA
##    5: 20.5 -11.5 31.13112 35.07441 33.79448
##   ---                                      
## 5078: 53.0  22.5       NA       NA       NA
## 5079: 53.0  23.0       NA       NA       NA
## 5080: 53.0  23.5       NA       NA       NA
## 5081: 53.0  24.0       NA       NA       NA
## 5082: 53.0  24.5       NA       NA       NA</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="data-import-and-processing-1.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if the ordering of the &#39;normal&#39; column was correct, we have below + normal + above = 100%:</span></span>
<span id="cb123-2"><a href="data-import-and-processing-1.html#cb123-2" aria-hidden="true" tabindex="-1"></a>check <span class="ot">=</span> <span class="fu">rowSums</span>(dt[,.(below,normal,above)])</span>
<span id="cb123-3"><a href="data-import-and-processing-1.html#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(check[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>])</span></code></pre></div>
<pre><code>##  [1]  NA  NA  NA  NA 100 100 100 100 100 100 100 100 100 100 100 100 100 100 100
## [20] 100</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="data-import-and-processing-1.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(check[<span class="sc">!</span><span class="fu">is.na</span>(check)])</span></code></pre></div>
<pre><code>## [1] 100</code></pre>
<p>This shows that the ordering was correct. We also could have solved this differently, by using <span class="math inline">\(\text{below} + \text{normal} + \text{above} = 100\%\)</span> directly:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="data-import-and-processing-1.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># only extract &#39;below&#39; and &#39;above&#39;:</span></span>
<span id="cb127-2"><a href="data-import-and-processing-1.html#cb127-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn), <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&#39;below&#39;</span>,<span class="st">&#39;above&#39;</span>),<span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb127-3"><a href="data-import-and-processing-1.html#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##        lon   lat    below    above
##    1: 20.5 -13.5       NA       NA
##    2: 20.5 -13.0       NA       NA
##    3: 20.5 -12.5       NA       NA
##    4: 20.5 -12.0       NA       NA
##    5: 20.5 -11.5 31.13112 33.79448
##   ---                             
## 5078: 53.0  22.5       NA       NA
## 5079: 53.0  23.0       NA       NA
## 5080: 53.0  23.5       NA       NA
## 5081: 53.0  24.0       NA       NA
## 5082: 53.0  24.5       NA       NA</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="data-import-and-processing-1.html#cb129-1" aria-hidden="true" tabindex="-1"></a>dt[,normal <span class="sc">:</span><span class="er">=</span> <span class="dv">100</span> <span class="sc">-</span> below <span class="sc">-</span> above]</span>
<span id="cb129-2"><a href="data-import-and-processing-1.html#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot_dt</span>(dt,<span class="st">&#39;normal&#39;</span>)</span></code></pre></div>
<p><img src="04-data_processing_examples_files/figure-html/unnamed-chunk-22-1.png" width="480" /></p>
</div>
<div id="data-ex-prexc" class="section level3" number="4.1.4">
<h3><span class="header-section-number">4.1.4</span> Example: preparing data for evaluating exceedence probabilities</h3>
<p>Here we show how to prepare data for evaluating exceedence probabilities, see Section <a href="validation.html#eval-ex-pr">5.3</a>.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="data-import-and-processing-1.html#cb130-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">=</span> <span class="st">&#39;PrecRegPeXcd_3monthSeasonal.nc&#39;</span></span>
<span id="cb130-2"><a href="data-import-and-processing-1.html#cb130-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">netcdf_to_dt</span>(<span class="fu">paste0</span>(data_dir,fn))</span></code></pre></div>
<pre><code>## File /nr/project/stat/CONFER/Data/SeaVal/example_data/202102/PrecRegPeXcd_3monthSeasonal.nc (NC_FORMAT_CLASSIC):
## 
##      1 variables (excluding dimension variables):
##         float pexcd[lon,lat,model,lead,rthr]   
##             thrhold4: 400
##             thrhold3: 350
##             thrhold2: 300
##             thrhold1: 200
##             units: %
##             _FillValue: -9999
## 
##      6 dimensions:
##         time  Size:0   *** is unlimited *** (no dimvar)
##         rthr  Size:4 
##         lead  Size:6 
##             units: months since 2021-2-1 0:0 
##         model  Size:9 
##             names: GEM-NEMO CanCM4i NASA-GEOSS2S GFDL-SPEAR COLA-RSMAS-CCSM4 NCEP-CFSv2 ECMWF Meteo_France UKMO
##         lat  Size:77 
##             units: degrees_north
##         lon  Size:66 
##             units: degrees_east
## 
##     5 global attributes:
##         modelnames: GEM-NEMO CanCM4i NASA-GEOSS2S GFDL-SPEAR COLA-RSMAS-CCSM4 NCEP-CFSv2 ECMWF Meteo_France UKMO
##         nmodels: 9
##         initial_time: Feb2021
##         creation_date: Thu Feb 25 19:58:57 EAT 2021
##         title:  Forecast probabilities of Exceedance</code></pre>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="data-import-and-processing-1.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##           lon   lat model lead rthr pexcd
##       1: 20.5 -13.5     0    0    0    NA
##       2: 21.0 -13.5     0    0    0    NA
##       3: 21.5 -13.5     0    0    0    NA
##       4: 22.0 -13.5     0    0    0    NA
##       5: 22.5 -13.5     0    0    0    NA
##      ---                                 
## 1097708: 51.0  24.5     8    5    3    NA
## 1097709: 51.5  24.5     8    5    3    NA
## 1097710: 52.0  24.5     8    5    3    NA
## 1097711: 52.5  24.5     8    5    3    NA
## 1097712: 53.0  24.5     8    5    3    NA</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="data-import-and-processing-1.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first, note that the &#39;model&#39;, &#39;rthr&#39;, and &#39;month&#39; column do not make much sense before we insert</span></span>
<span id="cb134-2"><a href="data-import-and-processing-1.html#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the information we gather from the netcdf description above:</span></span>
<span id="cb134-3"><a href="data-import-and-processing-1.html#cb134-3" aria-hidden="true" tabindex="-1"></a>modelnames <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;GEM-NEMO&#39;</span>,</span>
<span id="cb134-4"><a href="data-import-and-processing-1.html#cb134-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;CanCM4i&#39;</span>,</span>
<span id="cb134-5"><a href="data-import-and-processing-1.html#cb134-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;NASA-GEOSS2S&#39;</span>,</span>
<span id="cb134-6"><a href="data-import-and-processing-1.html#cb134-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;GFDL-SPEAR&#39;</span>,</span>
<span id="cb134-7"><a href="data-import-and-processing-1.html#cb134-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;COLA-RSMAS-CCSM4&#39;</span>,</span>
<span id="cb134-8"><a href="data-import-and-processing-1.html#cb134-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;NCEP-CFSv2&#39;</span>,</span>
<span id="cb134-9"><a href="data-import-and-processing-1.html#cb134-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;ECMWF&#39;</span>,</span>
<span id="cb134-10"><a href="data-import-and-processing-1.html#cb134-10" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;Meteo_France&#39;</span>,</span>
<span id="cb134-11"><a href="data-import-and-processing-1.html#cb134-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;UKMO&#39;</span>)</span>
<span id="cb134-12"><a href="data-import-and-processing-1.html#cb134-12" aria-hidden="true" tabindex="-1"></a>thresholds <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">200</span>,<span class="dv">300</span>,<span class="dv">350</span>,<span class="dv">400</span>)</span>
<span id="cb134-13"><a href="data-import-and-processing-1.html#cb134-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-14"><a href="data-import-and-processing-1.html#cb134-14" aria-hidden="true" tabindex="-1"></a>dt[,model <span class="sc">:</span><span class="er">=</span> modelnames[model <span class="sc">+</span> <span class="dv">1</span>]]</span>
<span id="cb134-15"><a href="data-import-and-processing-1.html#cb134-15" aria-hidden="true" tabindex="-1"></a>dt[,rthr <span class="sc">:</span><span class="er">=</span> thresholds[rthr <span class="sc">+</span> <span class="dv">1</span>]]</span>
<span id="cb134-16"><a href="data-import-and-processing-1.html#cb134-16" aria-hidden="true" tabindex="-1"></a>dt[,month <span class="sc">:</span><span class="er">=</span>lead <span class="sc">+</span> <span class="dv">2</span>][,lead<span class="sc">:</span><span class="er">=</span><span class="cn">NULL</span>]</span></code></pre></div>
<p>Ultimately, we want to compare the skill of these models to a climatological forecast. The climatological forecast for the exceedence probability is just the fraction of observed years where the threshold was exceeded. To calculate this, we require past observations. So let us load chirps again, only for the months contained in <code>dt</code>:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="data-import-and-processing-1.html#cb135-1" aria-hidden="true" tabindex="-1"></a>dt_chirps <span class="ot">=</span> <span class="fu">load_chirps</span>(<span class="at">months =</span> <span class="fu">unique</span>(dt[,month]))</span>
<span id="cb135-2"><a href="data-import-and-processing-1.html#cb135-2" aria-hidden="true" tabindex="-1"></a>dt_chirps[,prec<span class="sc">:</span><span class="er">=</span><span class="dv">30</span><span class="sc">*</span>prec] <span class="co"># convert to mm</span></span></code></pre></div>
<p>In order to get the climatological exceedence probabilities, we can use the following function:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="data-import-and-processing-1.html#cb136-1" aria-hidden="true" tabindex="-1"></a>clim_fc <span class="ot">=</span> <span class="fu">climatology_threshold_exceedence</span>(dt_chirps,</span>
<span id="cb136-2"><a href="data-import-and-processing-1.html#cb136-2" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">o =</span> <span class="st">&#39;prec&#39;</span>,</span>
<span id="cb136-3"><a href="data-import-and-processing-1.html#cb136-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">thresholds =</span> <span class="fu">unique</span>(dt[,rthr]),</span>
<span id="cb136-4"><a href="data-import-and-processing-1.html#cb136-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;month&#39;</span>,<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>))</span>
<span id="cb136-5"><a href="data-import-and-processing-1.html#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="data-import-and-processing-1.html#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(clim_fc)</span></code></pre></div>
<pre><code>##          month  lon   lat year     pexcd threshold
##       1:     2 21.5 -12.0 1981 0.3414634       200
##       2:     2 22.0 -12.0 1981 0.4634146       200
##       3:     2 22.5 -12.0 1981 0.5121951       200
##       4:     2 23.0 -12.0 1981 0.6585366       200
##       5:     2 23.5 -12.0 1981 0.5609756       200
##      ---                                          
## 4304156:     7 49.5  22.5 2022 0.0000000       400
## 4304157:     7 50.0  22.5 2022 0.0000000       400
## 4304158:     7 50.5  22.5 2022 0.0000000       400
## 4304159:     7 51.0  22.5 2022 0.0000000       400
## 4304160:     7 51.5  22.5 2022 0.0000000       400</code></pre>
<p>Note that we passed the thresholds given in <code>dt</code>. The <code>by</code> argument tells the function what columns to group by when computing the climatology. Finally, we need to merge the predictions, the climatological forecast and the observation into one data table. Since we only have predictions for 2021, it is enough to provide the climatology forecast and observation for 2021 as well. Also note that we have predictions for more months than observations (at the time this is written), so we cut the predictions for June and July out - we cannot evaluate predictions we don’t know the outcome for.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="data-import-and-processing-1.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(clim_fc,<span class="fu">c</span>(<span class="st">&#39;pexcd&#39;</span>,<span class="st">&#39;threshold&#39;</span>),<span class="fu">c</span>(<span class="st">&#39;clim&#39;</span>,<span class="st">&#39;rthr&#39;</span>))</span>
<span id="cb138-2"><a href="data-import-and-processing-1.html#cb138-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">merge</span>(dt,clim_fc[year <span class="sc">==</span> <span class="dv">2021</span>,],<span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>,<span class="st">&#39;month&#39;</span>,<span class="st">&#39;rthr&#39;</span>))</span>
<span id="cb138-3"><a href="data-import-and-processing-1.html#cb138-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">merge</span>(dt,dt_chirps[year <span class="sc">==</span> <span class="dv">2021</span>],<span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>,<span class="st">&#39;lat&#39;</span>,<span class="st">&#39;month&#39;</span>,<span class="st">&#39;year&#39;</span>))</span>
<span id="cb138-4"><a href="data-import-and-processing-1.html#cb138-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-5"><a href="data-import-and-processing-1.html#cb138-5" aria-hidden="true" tabindex="-1"></a><span class="co">#finally, for evaluation we generally work with probabilities between 0 and 1, not percentages:</span></span>
<span id="cb138-6"><a href="data-import-and-processing-1.html#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(dt[,pexcd],<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># confirm that the data table contains percentages at the moment...</span></span></code></pre></div>
<pre><code>## [1]   0 100</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="data-import-and-processing-1.html#cb140-1" aria-hidden="true" tabindex="-1"></a>dt[,pexcd <span class="sc">:</span><span class="er">=</span> pexcd<span class="sc">/</span><span class="dv">100</span>] <span class="co">#... and correct</span></span>
<span id="cb140-2"><a href="data-import-and-processing-1.html#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="data-import-and-processing-1.html#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dt)</span></code></pre></div>
<pre><code>##          lon   lat month year rthr            model pexcd      clim       prec
##      1: 21.5 -12.0     2 2021  200         GEM-NEMO 0.996 0.3170732 213.685669
##      2: 21.5 -12.0     2 2021  200          CanCM4i 0.995 0.3170732 213.685669
##      3: 21.5 -12.0     2 2021  200     NASA-GEOSS2S 0.996 0.3170732 213.685669
##      4: 21.5 -12.0     2 2021  200       GFDL-SPEAR 0.990 0.3170732 213.685669
##      5: 21.5 -12.0     2 2021  200 COLA-RSMAS-CCSM4 0.993 0.3170732 213.685669
##     ---                                                                       
## 922316: 51.5  22.5     7 2021  400 COLA-RSMAS-CCSM4 0.000 0.0000000   9.597914
## 922317: 51.5  22.5     7 2021  400       NCEP-CFSv2 0.000 0.0000000   9.597914
## 922318: 51.5  22.5     7 2021  400            ECMWF    NA 0.0000000   9.597914
## 922319: 51.5  22.5     7 2021  400     Meteo_France    NA 0.0000000   9.597914
## 922320: 51.5  22.5     7 2021  400             UKMO    NA 0.0000000   9.597914</code></pre>
<p>How to evaluate the predictions from here is discussed in Section <a href="validation.html#eval-ex-pr">5.3</a>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-import-and-processing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="validation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
